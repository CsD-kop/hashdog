"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var r=t[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,s,r){return s&&e(t.prototype,s),r&&e(t,r),t}}(),_get=function(e,t,s){for(var r=!0;r;){var i=e,o=t,a=s;n=l=h=void 0,r=!1,null===i&&(i=Function.prototype);var n=Object.getOwnPropertyDescriptor(i,o);if(void 0!==n){if("value"in n)return n.value;var h=n.get;return void 0===h?void 0:h.call(a)}var l=Object.getPrototypeOf(i);if(null===l)return void 0;e=l,t=o,s=a,r=!0}},_workersPermutator=require("./workers/Permutator"),_workersWordlist=require("./workers/Wordlist"),_workersPasswords=require("./workers/Passwords"),_utilUtil=require("./util/Util"),_queueTask=require("./queue/Task"),_events=require("events"),HashDog=function(e){function t(e){var s=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e);var r=/^[0-9a-f]{40}$/i,i=/^[0-9a-f]{64}$/i,o=/^[0-9a-f]{128}$/i,a=/^[0-9a-f]{32}$/i,n=0,h=void 0,l=void 0,c=require("os").cpus().length;if(!e||!e.hash)throw new Error("Missing options!");if(!e.hash)throw new Error("Missing hash!");if(!e.type)if(a.test(e.hash))e.type="MD5";else if(r.test(e.hash))e.type="SHA1";else if(i.test(e.hash))e.type="SHA256";else{if(!o.test(e.hash))throw new Error("Please specify hash type!");e.type="SHA512"}switch(e.type){case"MD5":if(!a.test(e.hash))throw new Error("Invalid MD5 hash!");break;case"SHA1":if(!r.test(e.hash))throw new Error("Invalid SHA1 hash!");break;case"SHA256":if(!i.test(e.hash))throw new Error("Invalid SHA256 hash!");break;case"SHA512":if(!o.test(e.hash))throw new Error("Invalid SHA512 hash!")}if(e&&"CLI"===e.environment?this.environment="CLI":this.environment="LIB",this.cluster=require("cluster"),this.refreshRate=500,this.startDate=new Date,this.match=e.hash.toLowerCase(),this.type=e.type,this.chars=e.chars||"ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz0123456789",this.fixedLength=e.length,this.workers=new Map,this.status=new Map,this.lastDate=new Date,this.wordlist=new _workersWordlist.Wordlist({match:this.match,type:this.type,refreshRate:this.refreshRate}),this.passwords=new _workersPasswords.Passwords({match:this.match,type:this.type,refreshRate:this.refreshRate}),this.permutator=new _workersPermutator.Permutator({match:this.match,type:this.type,refreshRate:this.refreshRate}),this.cluster.isMaster)if(l=new _queueTask.Task({type:"WORDLIST"}),this.addWorker(l),l=new _queueTask.Task({type:"PASSWORD"}),this.addWorker(l),this.fixedLength)l=new _queueTask.Task({type:"PERMUTATOR",length:this.fixedLength}),this.addWorker(l);else for(h=Math.abs(c-this.workers.size),n=0;h>n;n++)this.permutator.currentMaxLength++,l=new _queueTask.Task({type:"PERMUTATOR",length:this.permutator.currentMaxLength}),this.addWorker(l);else this.cluster.isWorker&&process.on("message",function(e){s.messageHandler(e)})}return _inherits(t,e),_createClass(t,[{key:"addWorker",value:function(e){var t=this,s=this.cluster.fork();e.workerId=s.id,s.on("message",function(e){t.messageHandler(e)}),this.workers.set(s.id.toString(),e),s.send(e)}},{key:"deleteWorker",value:function(e){this.cluster.workers[e].kill(),this.cluster.workers[e].removeAllListeners("message"),this.workers["delete"](e),this.status["delete"](e)}},{key:"messageHandler",value:function(e){if(this.cluster.isMaster){if(e.hasOwnProperty("command"))switch(e.command){case"DISPLAY":"CLI"===this.environment?this.display(e):"LIB"===this.environment&&this.sendEvents(e);break;case"DONE":this.deleteWorker(e.workerId),this.permutator.currentMaxLength++;var t=new _queueTask.Task({type:"PERMUTATOR",length:this.permutator.currentMaxLength});this.addWorker(t)}}else if(this.cluster.isWorker&&e.hasOwnProperty("command")&&"setupWorker"===e.command)switch(e.options.type){case"WORDLIST":this.wordlist.initializeWorker(e.workerId),this.wordlist.initialize({length:this.fixedLength});break;case"PASSWORD":this.passwords.initializeWorker(e.workerId),this.passwords.initialize({length:this.fixedLength});break;case"PERMUTATOR":this.permutator.initializeWorker(e.workerId),this.permutator.initialize({length:e.options.length,chars:this.chars})}}},{key:"display",value:function(e){var t=new Date,s=void 0,r=!1,i="",o=1,a=0,n=require("colors/safe");this.status.set(e.workerId,e),s=t-this.lastDate,s<=this.refreshRate||(_utilUtil.Util.cls(),this.status.forEach(function(e){!e.hasOwnProperty("status")||"Working"!==e.status&&"SUCCESS"!==e.status||(a+=e.rate),e.success===!0&&(r=!0,i=e.string)}),console.log("hashdog by @logotype. Copyright Â© 2015. Released under the MIT license."),console.log("Hash: "+n.yellow(this.match)+" type: "+n.magenta(this.type)+" characters: "+n.cyan(this.chars)),console.log("Current rate combined..: "+a.toFixed(2)+" kHash/s"),console.log(""),this.status.forEach(function(e){e.hasOwnProperty("status")&&(console.log("PROCESS "+e.workerId+": "+e.name),console.log("  Status...............: "+n.yellow(e.status)),console.log("  Uptime...............: "+e.uptime+" seconds"),console.log("  Key length...........: "+_utilUtil.Util.numberWithCommas(e.keyLength)),console.log("  Keys (tried).........: "+_utilUtil.Util.numberWithCommas(e.keysTried)),console.log("  Keys (total).........: "+_utilUtil.Util.numberWithCommas(e.keysTotal)),console.log("  Percentage...........: "+e.percentage+"%"),console.log("  Rate.................: "+e.rate.toFixed(2)+" kHash/s"),console.log("  String...............: "+n.cyan(e.string))),o++}),r&&(s=t-this.startDate,console.log("----------------------------------------------------------------------"),console.log("Started................: "+this.startDate.toUTCString()),console.log("Ended..................: "+t.toUTCString()),console.log("The process took "+(s/1e3).toFixed(2)+" seconds."),console.log(this.match+" : "+n.green(i)),process.exit(0)),this.lastDate=t)}},{key:"sendEvents",value:function(e){var t=this,s=!1,r="";this.status.set(e.workerId,e),this.status.forEach(function(e){e.hasOwnProperty("status")&&t.emit("progress",e),e.success===!0&&(s=!0,r=e.string)}),s&&(this.emit("success",{hash:this.match,string:r}),process.exit(0))}}]),t}(_events.EventEmitter);exports.HashDog=HashDog,exports["default"]=HashDog;