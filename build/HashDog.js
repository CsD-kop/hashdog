"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var r=t[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,s,r){return s&&e(t.prototype,s),r&&e(t,r),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.HashDog=void 0;var _Permutator=require("./workers/Permutator"),_Wordlist=require("./workers/Wordlist"),_Passwords=require("./workers/Passwords"),_Util=require("./util/Util"),_Task=require("./queue/Task"),_events=require("events"),HashDog=exports.HashDog=function(e){function t(e){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e)),r=/^[0-9a-f]{40}$/i,o=/^[0-9a-f]{64}$/i,a=/^[0-9a-f]{128}$/i,i=/^[0-9a-f]{32}$/i,n=require("os").cpus().length,h=0,l=0,c=null;if(!e||!e.hash)throw new Error("Missing options!");if(!e.hash)throw new Error("Missing hash!");if(!e.type)if(i.test(e.hash))e.type="MD5";else if(r.test(e.hash))e.type="SHA1";else if(o.test(e.hash))e.type="SHA256";else{if(!a.test(e.hash))throw new Error("Please specify hash type!");e.type="SHA512"}switch(e.type){case"MD5":if(!i.test(e.hash))throw new Error("Invalid MD5 hash!");break;case"SHA1":if(!r.test(e.hash))throw new Error("Invalid SHA1 hash!");break;case"SHA256":if(!o.test(e.hash))throw new Error("Invalid SHA256 hash!");break;case"SHA512":if(!a.test(e.hash))throw new Error("Invalid SHA512 hash!")}if(e&&"CLI"===e.environment?s.environment="CLI":s.environment="LIB",s.cluster=require("cluster"),s.refreshRate=500,s.startDate=new Date,s.match=e.hash.toLowerCase(),s.type=e.type,s.chars=e.chars||"ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz0123456789",s.fixedLength=e.length,s.workers=new Map,s.status=new Map,s.lastDate=new Date,s.wordlist=new _Wordlist.Wordlist({match:s.match,type:s.type,refreshRate:s.refreshRate}),s.passwords=new _Passwords.Passwords({match:s.match,type:s.type,refreshRate:s.refreshRate}),s.permutator=new _Permutator.Permutator({match:s.match,type:s.type,refreshRate:s.refreshRate}),s.cluster.isMaster)if(c=new _Task.Task({type:"WORDLIST"}),s.addWorker(c),c=new _Task.Task({type:"PASSWORD"}),s.addWorker(c),s.fixedLength)c=new _Task.Task({type:"PERMUTATOR",length:s.fixedLength}),s.addWorker(c);else for(l=Math.abs(n-s.workers.size),h=0;l>h;h++)s.permutator.currentMaxLength++,c=new _Task.Task({type:"PERMUTATOR",length:s.permutator.currentMaxLength}),s.addWorker(c);else s.cluster.isWorker&&process.on("message",function(e){s.messageHandler(e)});return s}return _inherits(t,e),_createClass(t,[{key:"addWorker",value:function(e){var t=this,s=this.cluster.fork();e.workerId=s.id,s.on("message",function(e){t.messageHandler(e)}),this.workers.set(s.id.toString(),e),s.send(e)}},{key:"deleteWorker",value:function(e){this.cluster.workers[e].removeAllListeners("message"),this.cluster.workers[e].kill(),this.workers["delete"](e),this.status["delete"](e)}},{key:"messageHandler",value:function(e){if(this.cluster.isMaster){if(e.hasOwnProperty("command"))switch(e.command){case"DISPLAY":"CLI"===this.environment?this.display(e):"LIB"===this.environment&&this.sendEvents(e);break;case"DONE":this.deleteWorker(e.workerId),this.permutator.currentMaxLength++;var t=new _Task.Task({type:"PERMUTATOR",length:this.permutator.currentMaxLength});this.addWorker(t)}}else if(this.cluster.isWorker&&e.hasOwnProperty("command")&&"setupWorker"===e.command)switch(e.options.type){case"WORDLIST":this.wordlist.initializeWorker(e.workerId),this.wordlist.initialize({length:this.fixedLength});break;case"PASSWORD":this.passwords.initializeWorker(e.workerId),this.passwords.initialize({length:this.fixedLength});break;case"PERMUTATOR":this.permutator.initializeWorker(e.workerId),this.permutator.initialize({length:e.options.length,chars:this.chars})}}},{key:"display",value:function(e){var t=new Date,s=require("colors/safe"),r=t-this.lastDate,o=!1,a="",i=1,n=0;this.status.set(e.workerId,e),r<=this.refreshRate||(_Util.Util.cls(),this.status.forEach(function(e){!e.hasOwnProperty("status")||"Working"!==e.status&&"SUCCESS"!==e.status||(n+=e.rate),e.success===!0&&(o=!0,a=e.string)}),console.log("hashdog by @logotype. Copyright Â© 2015. Released under the MIT license."),console.log("Hash: "+s.yellow(this.match)+" type: "+s.magenta(this.type)+" characters: "+s.cyan(this.chars)),console.log("Current rate combined..: "+n.toFixed(2)+" kHash/s"),console.log(""),this.status.forEach(function(e){e.hasOwnProperty("status")&&(console.log("PROCESS "+e.workerId+": "+e.name),console.log("  Status...............: "+s.yellow(e.status)),console.log("  Uptime...............: "+e.uptime+" seconds"),console.log("  Key length...........: "+_Util.Util.numberWithCommas(e.keyLength)),console.log("  Keys (tried).........: "+_Util.Util.numberWithCommas(e.keysTried)),console.log("  Keys (total).........: "+_Util.Util.numberWithCommas(e.keysTotal)),console.log("  Percentage...........: "+e.percentage+"%"),console.log("  Rate.................: "+e.rate.toFixed(2)+" kHash/s}"),console.log("  String...............: "+s.cyan(e.string))),i++}),o&&(r=t-this.startDate,console.log("----------------------------------------------------------------------"),console.log("Started................: "+this.startDate.toUTCString()),console.log("Ended..................: "+t.toUTCString()),console.log("The process took "+(r/1e3).toFixed(2)+" seconds."),console.log(this.match+" : "+s.green(a)),process.exit(0)),this.lastDate=t)}},{key:"sendEvents",value:function(e){var t=this,s=!1,r="";this.status.set(e.workerId,e),this.status.forEach(function(e){e.hasOwnProperty("status")&&t.emit("progress",e),e.success===!0&&(s=!0,r=e.string)}),s&&(this.emit("success",{hash:this.match,string:r}),process.exit(0))}}]),t}(_events.EventEmitter);exports["default"]=HashDog;